<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カードめくりゲーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* bg-gray-800 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
            padding: 1rem;
        }
        .perspective {
            perspective: 1000px;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.7s;
            transform-style: preserve-3d;
        }
        .is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari */
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-size: 100% 100%;
            background-position: center;
        }
        /* カードの裏面 */
        .card-back {
            background-image: url('https://itdaiz178.github.io/cards/images/card_back3.jpg');
            background-size: 100% 100%;
            border: 3px solid #ddd;
        }
        /* カードの表面 */
        .card-front {
            background-color: #FFFFFF;
            transform: rotateY(180deg);
        }
        .symbol-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.75rem;
        }

        /* アニメーション用のスタイル */
        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 1s ease-in-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-up {
            animation: slideUp 0.5s ease-out forwards;
            transform: translateY(100vh); /* 初期位置を画面外に設定 */
        }

        @keyframes slideUp {
            from { transform: translateY(100vh); opacity: 0; } /* 画面の高さを基準に画面外から開始 */
            to { transform: translateY(0); opacity: 1; }
        }
        
        #game-board {
            /* flexboxで中央寄せ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        .card-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }
    </style>
</head>
<body>

    <!-- スタート画面 -->
    <div id="start-screen" class="flex flex-col items-center">
        <button id="start-button" class="px-6 py-3 bg-yellow-500 text-white font-bold rounded-lg shadow-md hover:bg-yellow-600 transition-colors">
            スタート
        </button>
    </div>

    <!-- ゲーム画面 -->
    <div id="game-screen" class="hidden">
        <!-- カードを配置するゲームボード -->
        <div id="game-board" class="fade-in">
            <!-- カードはJavaScriptによってここに動的に生成されます -->
        </div>

        <!-- リスタートボタン (初期は非表示) -->
        <button id="restart-button" class="mt-8 px-6 py-3 bg-yellow-500 text-white font-bold rounded-lg shadow-md hover:bg-yellow-600 transition-colors hidden">
            リスタート
        </button>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const startScreen = document.getElementById('start-screen');
            const gameScreen = document.getElementById('game-screen');
            const startButton = document.getElementById('start-button');
            const restartButton = document.getElementById('restart-button');
            const gameBoard = document.getElementById('game-board');

            let flippedCardCount = 0;
            let totalCards = 0;
            let audioContext;
            let soundBuffers = {};

            // カード絵柄、画像、出現確率を定義
            const cardSymbols = [
                { id: 'ur_cat', image: 'https://itdaiz178.github.io/cards/images/card_ur_cat2.png', probability: 10 },
                { id: 'ur_medal', image: 'https://itdaiz178.github.io/cards/images/card_ur_medal.png', probability: 30 },
                { id: 'coin', image: 'https://placehold.co/200x280/ffd700/000000?text=coin.jpg', probability: 60 }
            ];

            // 効果音のファイルパスを定義
            const soundFiles = {
                cardDeal: 'https://itdaiz178.github.io/cards/sounds/dealing_cards.mp3', // カードを配置する音
                cardFlip: 'https://itdaiz178.github.io/cards/sounds/open_a_card.mp3' // カードをめくる音
            };

            // カードのレイアウト（行ごとの枚数）
            const layout = [2, 3, 3, 2];

            // 効果音の読み込み
            async function loadSounds() {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                for (const soundName in soundFiles) {
                    try {
                        const response = await fetch(soundFiles[soundName]);
                        const arrayBuffer = await response.arrayBuffer();
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        soundBuffers[soundName] = audioBuffer;
                    } catch (error) {
                        console.error(`Error loading sound file: ${soundFiles[soundName]}`, error);
                    }
                }
            }

            // 確率に基づいてカードを生成する関数
            function getRandomSymbol() {
                const totalProbability = cardSymbols.reduce((sum, symbol) => sum + symbol.probability, 0);
                const randomValue = Math.random() * totalProbability;
                
                let cumulativeProbability = 0;
                for (const symbol of cardSymbols) {
                    cumulativeProbability += symbol.probability;
                    if (randomValue <= cumulativeProbability) {
                        return symbol;
                    }
                }
                return cardSymbols[0];
            }

            // 効果音を再生する関数
            function playSound(soundName) {
                if (soundBuffers[soundName]) {
                    const source = audioContext.createBufferSource();
                    source.buffer = soundBuffers[soundName];
                    source.connect(audioContext.destination);
                    source.start();
                }
            }

            // ゲームのセットアップ
            function setupGame() {
                gameBoard.innerHTML = '';
                flippedCardCount = 0;
                totalCards = layout.reduce((sum, count) => sum + count, 0);
                restartButton.classList.add('hidden');

                // 確率に基づいてデッキを生成
                const deck = [];
                for (let i = 0; i < totalCards; i++) {
                    const randomSymbol = getRandomSymbol();
                    deck.push(randomSymbol);
                }

                // デッキをシャッフル
                const shuffledDeck = deck.sort(() => Math.random() - 0.5);
                
                let cardIndex = 0;
                layout.forEach(count => {
                    const row = document.createElement('div');
                    row.className = 'card-row';
                    
                    for (let i = 0; i < count; i++) {
                        if (cardIndex < shuffledDeck.length) {
                            const cardSymbol = shuffledDeck[cardIndex];
                            
                            const cardElement = document.createElement('div');
                            // slide-upアニメーションを適用
                            cardElement.className = 'perspective w-24 h-36 md:w-28 md:h-44 cursor-pointer slide-up';
                            cardElement.style.animationDelay = `${cardIndex * 0.1}s`; // アニメーションに遅延を付けて順番に出現させる

                            cardElement.innerHTML = `
                                <div class="card-inner">
                                    <div class="card-face card-front">
                                        <img src="${cardSymbol.image}" alt="${cardSymbol.id}" class="symbol-image">
                                    </div>
                                    <div class="card-face card-back"></div>
                                </div>
                            `;

                            // アニメーション開始時に効果音を再生
                            cardElement.addEventListener('animationstart', (event) => {
                                if (event.animationName === 'slideUp') {
                                    playSound('cardDeal');
                                }
                            });
                            
                            cardElement.addEventListener('click', () => {
                                if (!cardElement.classList.contains('is-flipped')) {
                                    cardElement.classList.add('is-flipped');
                                    playSound('cardFlip'); // カードをめくる効果音を再生
                                    flippedCardCount++;
                                    // すべてのカードがめくられたかチェック
                                    if (flippedCardCount === totalCards) {
                                        setTimeout(() => {
                                            restartButton.classList.remove('hidden');
                                        }, 1000); // アニメーション後にボタンを表示
                                    }
                                }
                            });
                            
                            row.appendChild(cardElement);
                            cardIndex++;
                        }
                    }
                    gameBoard.appendChild(row);
                });
            }

            // スタートボタンのクリックイベント
            startButton.addEventListener('click', () => {
                // 音声コンテキストを有効にするために、ユーザーの操作後にロードを開始
                loadSounds().then(() => {
                    startScreen.classList.add('hidden');
                    gameScreen.classList.remove('hidden');
                    setupGame();
                });
            });

            // リスタートボタンのクリックイベント
            restartButton.addEventListener('click', () => {
                setupGame();
            });

        });
    </script>

</body>
</html>


